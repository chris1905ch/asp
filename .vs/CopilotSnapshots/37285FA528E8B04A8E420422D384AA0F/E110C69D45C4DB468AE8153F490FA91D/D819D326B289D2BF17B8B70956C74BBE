using System;
using System.Collections.Generic;
using System.Linq;
using System.Web.Mvc;
using SistemaHotel.Models;

namespace SistemaHotel.Controllers
{
    public class DashboardController : Controller
    {
        private HotelDBEntities1 db = new HotelDBEntities1();

        public ActionResult Index()
        {
            // Reservas por mes (últimos 12 meses)
            var now = DateTime.Now;
            var reservasPorMes = db.Reservas
                .Where(r => r.FechaIngreso.Year >= now.Year - 1)
                .GroupBy(r => new { r.FechaIngreso.Year, r.FechaIngreso.Month })
                .Select(g => new {
                    Year = g.Key.Year,
                    Month = g.Key.Month,
                    Count = g.Count()
                })
                .ToList();

            // Ingresos por mes (Pagos)
            var pagosPorMes = db.Pagos
                .Where(p => p.Fecha.Year >= now.Year - 1)
                .GroupBy(p => new { p.Fecha.Year, p.Fecha.Month })
                .Select(g => new {
                    Year = g.Key.Year,
                    Month = g.Key.Month,
                    Total = g.Sum(x => x.Monto)
                })
                .ToList();

            // Ocupación actual (reservas activas hoy)
            var ocupacionActual = db.Reservas.Count(r => r.FechaIngreso <= now && r.FechaSalida >= now);
            var totalHabitaciones = db.Habitaciones.Count();

            ViewBag.ReservasPorMes = reservasPorMes;
            ViewBag.PagosPorMes = pagosPorMes;
            ViewBag.OcupacionActual = ocupacionActual;
            ViewBag.TotalHabitaciones = totalHabitaciones;

            return View();
        }
    }
}
